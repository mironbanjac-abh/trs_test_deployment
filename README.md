# ARIMA Time Series Forecasting API

This deployment provides a REST API for time series forecasting using ARIMA (AutoRegressive Integrated Moving Average) models. The API is designed to predict the next score in a sequence of student performance scores and provides multiple confidence interval calculations.

## üìã Table of Contents

- [Installation](#installation)
- [Quick Start](#quick-start)
- [API Documentation](#api-documentation)
- [Output Metrics Explained](#output-metrics-explained)
- [Confidence Intervals](#confidence-intervals)
- [Docker Deployment](#docker-deployment)
- [Testing](#testing)
- [Error Handling](#error-handling)

## üöÄ Installation

### Prerequisites
- Python 3.9+
- pip package manager

### Local Installation

1. **Clone or navigate to the deployment directory:**
   ```bash
   cd deployment
   ```

2. **Install dependencies:**
   ```bash
   pip install -r requirements.txt
   ```

3. **Run the API:**
   ```bash
   uvicorn app:app --host 0.0.0.0 --port 8000
   ```

The API will be available at `http://localhost:8000`

## üèÅ Quick Start

### Starting the Server
```bash
uvicorn app:app --host 0.0.0.0 --port 8000 --reload
```

### Making a Prediction Request
```python
import requests

payload = {
    "scores": [0.9, 0.88, 0.75, 0.78, 0.74, 0.69, 0.95, 0.88, 0.9, 0.63],
    "window_size": 5
}

response = requests.post("http://localhost:8000/forecast", json=payload)
print(response.json())
```

## üìñ API Documentation

### Endpoint: `POST /forecast`

Generates ARIMA-based forecasts for time series data with confidence intervals.

#### Request Body

```json
{
    "scores": [0.9, 0.88, 0.75, 0.78, 0.74],
    "window_size": 5
}
```

**Parameters:**
- `scores` (List[float], required): Array of score values between 0.0 and 1.0
- `window_size` (int, optional): Rolling window size for statistical calculations (default: 5)

**Validation Rules:**
- All scores must be between 0.0 and 1.0
- `window_size` must be positive and smaller than the number of scores
- Minimum number of scores required: `window_size + 1`

#### Response Format

```json
{
    "prediction": 0.8429657738146251,
    "CI_from_arima": [
        0.5227539859222485,
        1.1631775617070017
    ],
    "CI_from_arima_above_threshold_pct": 41.09429628422297,
    "CI_from_normal_distribution": [
        0.5659258649366603,
        1.12000568269259
    ],
    "CI_from_normal_distribution_above_threshold_pct": 39.706496364302104,
    "CI_from_t_distribution": [
        0.7438745677895089,
        0.9420569798397413
    ],
    "CI_from_t_distribution_above_threshold_pct": 39.706496364302104,
    "best_order": [
        1,
        0,
        1
    ],
    "MSE": 0.025422259168358323,
    "RMSE": 0.1594435924343099,
    "MAE": 0.11979553755075785
}
```

## üìä Output Metrics Explained

### Core Prediction
- **`prediction`**: The forecasted next score value generated by the ARIMA model

### Model Selection
- **`best_order`**: The optimal ARIMA(p,d,q) parameters selected through automated model selection
  - `p`: Number of autoregressive terms
  - `d`: Degree of differencing
  - `q`: Number of moving average terms

### Model Performance Metrics
- **`MSE`** (Mean Squared Error): Average of squared differences between actual and fitted values
- **`RMSE`** (Root Mean Squared Error): Square root of MSE, in the same units as the original data
- **`MAE`** (Mean Absolute Error): Average of absolute differences between actual and fitted values

## üîç Confidence Intervals

The API provides three different methods for calculating confidence intervals, each with its own statistical foundation:

### 1. ARIMA-Based Confidence Interval
**Field**: `CI_from_arima`

**Calculation Method**: 
- Uses the ARIMA model's built-in forecast confidence intervals
- Based on the model's residual variance and parameter uncertainty
- Calculated using `forecast_result.conf_int(alpha=0.05)` for 95% confidence level

**Formula**: 
```
CI = prediction ¬± z_{Œ±/2} √ó ‚àö(forecast_variance)
```

**Use Case**: Most theoretically sound for ARIMA predictions as it accounts for model-specific uncertainty.

### 2. Normal Distribution Confidence Interval
**Field**: `CI_from_normal_distribution`

**Calculation Method**:
- Assumes the prediction follows a normal distribution
- Uses rolling standard deviation from the window
- Applies a 2-sigma rule (Œ± = 2)

**Formula**:
```
CI = prediction ¬± 2 √ó rolling_std
```

**Use Case**: Simple and robust approach when you want conservative estimates.

### 3. T-Distribution Confidence Interval
**Field**: `CI_from_t_distribution`

**Calculation Method**:
- Uses Student's t-distribution to account for small sample sizes
- Based on rolling statistics within the specified window
- Calculates standard error using sample size

**Formula**:
```
CI = prediction ¬± t_{Œ±/2,df} √ó (rolling_std / ‚àön)
```

Where:
- `t_{Œ±/2,df}`: Critical t-value for 95% confidence level
- `df`: Degrees of freedom (window_size - 1)
- `n`: Sample size (window_size)

**Use Case**: Most appropriate for small sample sizes and provides more accurate intervals when the population standard deviation is unknown.

### Threshold Analysis

Each confidence interval includes a "percentage above threshold" metric:

**Fields**: 
- `CI_from_arima_above_threshold_pct`
- `CI_from_normal_distribution_above_threshold_pct`
- `CI_from_t_distribution_above_threshold_pct`

**Calculation**: Percentage of the confidence interval that lies above the threshold (default: 0.9)

**Formula**:
```
percentage = (max(0, upper_bound - max(lower_bound, threshold)) / (upper_bound - lower_bound)) √ó 100
```

**Interpretation**:
- 0%: Entire interval is below threshold
- 100%: Entire interval is above threshold
- 50%: Threshold bisects the interval

## üê≥ Docker Deployment

### Building the Docker Image
```bash
docker build -t arima-service .
```

### Running the Container
```bash
docker run -p 8000:8000 arima-service
```

### Docker Compose (Optional)
Create a `docker-compose.yml`:

```yaml
version: '3.8'
services:
  arima-api:
    build: .
    ports:
      - "8000:8000"
    environment:
      - ENV=production
```

Run with:
```bash
docker-compose up
```

## üß™ Testing

### Using the Test Client
```bash
python test_client.py
```

### Manual Testing with cURL
```bash
curl -X POST "http://localhost:8000/forecast" \
     -H "Content-Type: application/json" \
     -d '{
       "scores": [0.9, 0.88, 0.75, 0.78, 0.74, 0.69, 0.95, 0.88, 0.9, 0.63],
       "window_size": 5
     }'
```

### API Documentation
Once the server is running, visit:
- Swagger UI: `http://localhost:8000/docs`
- ReDoc: `http://localhost:8000/redoc`

## ‚ùå Error Handling

### Common Error Responses

**400 Bad Request - Invalid Score Range:**
```json
{
    "detail": "Score at index 2 (1.5) must be between 0.0 and 1.0"
}
```

**400 Bad Request - Invalid Window Size:**
```json
{
    "detail": "window_size (10) must be smaller than the number of scores (5)"
}
```

**400 Bad Request - Non-positive Window Size:**
```json
{
    "detail": "window_size must be a positive integer"
}
```

**500 Internal Server Error - Model Fitting Issues:**
```json
{
    "detail": "ARIMA model failed to converge"
}
```

## üîß Configuration

### Environment Variables
- `HOST`: Server host (default: 0.0.0.0)
- `PORT`: Server port (default: 8000)
- `ENV`: Environment setting (development/production)

### Model Parameters
- **Default window_size**: 5
- **Confidence level**: 95% (Œ± = 0.05)
- **Threshold for percentage calculations**: 0.9
- **ARIMA model selection**: Automatic using `pmdarima.auto_arima`

## üìà Performance Considerations

- **Model Selection**: The API uses stepwise algorithm first, falling back to grid search if needed
- **Memory Usage**: Minimal - processes one prediction at a time
- **Response Time**: Typically < 1 second for datasets with < 100 points
- **Scalability**: Stateless design allows for horizontal scaling
